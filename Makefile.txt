# Makefile for Zidisha Loyalty Platform

.PHONY: dev prod up down build clean logs logs-api logs-frontend db-shell test-backend

# Start development environment
dev:
	docker-compose -f docker-compose.yml up --build --remove-orphans --wait frontend api db redis

# Start production environment
prod:
	docker-compose -f docker-compose.yml up --build --remove-orphans --wait frontend-prod api-prod db redis nginx

# Bring up all services (default to dev profile)
up:
	docker-compose -f docker-compose.yml up --build --remove-orphans --wait

# Bring down all services
down:
	docker-compose -f docker-compose.yml down --remove-orphans

# Build all services
build:
	docker-compose -f docker-compose.yml build

# Clean up Docker resources
clean:
	docker-compose -f docker-compose.yml down --volumes --rmi all --remove-orphans

# View logs for all services
logs:
	docker-compose -f docker-compose.yml logs -f

# View logs for API service
logs-api:
	docker-compose -f docker-compose.yml logs -f api

# View logs for Frontend service
logs-frontend:
	docker-compose -f docker-compose.yml logs -f frontend

# Access PostgreSQL database shell
db-shell:
	docker-compose -f docker-compose.yml exec db psql -U postgres zidisha_db

# Run backend tests in a dedicated container
test-backend:
	docker-compose -f docker-compose.yml build test # Ensure the test service image is built
	docker-compose -f docker-compose.yml run --rm test # Run tests and remove container afterwards